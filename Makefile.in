# Copyright (c) 2005 Atheme Development Group.
# Rights to this code are documented in doc/LICENSE.
#
# This file contains build instructions.
#
# $Id: Makefile.in 8379 2007-06-03 20:26:51Z pippijn $
#

CC		= @CC@
RM		= @RM@
MV		= @MV@
CP		= @CP@
LN		= @LN@
TAR		= @TAR@
SHELL		= /bin/sh
INSTALL		= @INSTALL@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
datarootdir	= @datarootdir@
bindir		= @bindir@
datadir		= @datadir@
sysconfdir	= @sysconfdir@
libdir		= @libdir@
sbindir		= @sbindir@
localstatedir	= @localstatedir@
DOCDIR		= @DOCDIR@
MODDIR		= @MODDIR@
LOCALEDIR	= @LOCALEDIR@
SHAREDIR	= @SHAREDIR@
SRCDIR		= @SRCDIR@
BUILDDIR	= @BUILDDIR@
BIN		= atheme@EXEEXT@
DISTNAME	= @PACKAGE_NAME@-@PACKAGE_VERSION@

SUBDIRS=@LIBMOWGLI@ modules src po
CLEANDIRS = ${SUBDIRS}

.PHONY: dist depend

all: build

build: depend
	-@if [ ! -f include/sysconf.h ] ; then \
		echo "Hmm...doesn't look like you've run configure..."; \
		echo "Doing so now."; \
		sh configure; \
	fi
	@if [ -d .hg ] ; then \
		revh=`hg tip --template '#define SERNO "#rev#:#node|short#"\n' 2>/dev/null`;\
		[ -z "$$revh" ] || echo "$$revh" >include/serno.h ; \
	fi
	@for i in $(SUBDIRS); do \
		echo "build ==> $$i"; \
		cd $$i; \
		${MAKE} build || exit; cd ..; \
	done

clean:
	${RM} -f *~ core atheme.core
	@for i in $(CLEANDIRS); do \
		echo "clean ==> $$i"; \
		cd $$i; \
		${MAKE} clean; cd ..; \
	done
	-@if [ -f include/sysconf.h ] ; then \
		echo "To really restart installation, make distclean"; \
	fi

distclean:
	cd include; ${RM} -f sysconf.h *~ *.orig; cd ..
	@for i in $(CLEANDIRS); do \
		echo "distclean ==> $$i"; \
		cd $$i; \
		${MAKE} distclean; cd ..; \
	done
	${RM} -f Makefile *~ *.orig core atheme.core
	${RM} -f config.status config.cache config.log

maintainer-clean: distclean
	${RM} -rf autom4te.cache
	${RM} -f configure aclocal.m4

depend: include/hooktypes.h
	@[ -f include/serno.h ] || echo '#define SERNO "unknown"' >include/serno.h
	@for i in $(SUBDIRS); do \
		echo "depend ==> $$i"; \
		cd $$i; \
		touch .depend; \
		${MAKE} depend; cd ..; \
	done
	@echo "depend ==> contrib"; cd contrib; touch .depend && ${MAKE} depend || echo '(error ignored)'; cd ..

install: build
	@for i in $(SUBDIRS); do \
		echo "install ==> $$i"; \
		cd $$i; \
		${MAKE} install; \
		cd ..; \
	done

	@echo "----------------------------------------------------------------"
	@echo ">>> Remember to cd to ${prefix} and edit your config file.";
	@echo "----------------------------------------------------------------"

dist:
	@if [ ! -d .hg ]; then \
		echo "make dist only works from a mercurial tree"; \
		false; \
	fi
	hg tip --template '#define SERNO "#rev#:#node|short#"\n' >include/serno.h
	@echo "Creating $(DISTNAME).tar.gz"
	$(RM) -f $(DISTNAME)
	$(LN) -s . $(DISTNAME)
	hg manifest | awk '{ print "$(DISTNAME)/"$$1; } END { print "$(DISTNAME)/configure"; print "$(DISTNAME)/aclocal.m4"; print "$(DISTNAME)/include/sysconf.h.in"; print "$(DISTNAME)/include/serno.h"; }' | $(TAR) -chnzf $(DISTNAME).tar.gz -T /dev/stdin
	$(RM) $(DISTNAME)

include/hooktypes.h: ${SRCDIR}/src/mkhooktypes.sh ${SRCDIR}/src/hooktypes.in
	(cd src && touch .depend && ${MAKE} ../include/hooktypes.h)
