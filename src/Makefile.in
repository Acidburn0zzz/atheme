# Copyright (c) 2005 Atheme Development Group
# Rights to this code are documented in doc/LICENSE.
#
# This file contains build instructions.
#
# $Id: Makefile.in 8413 2007-06-04 18:45:05Z pippijn $
#

CC		= @CC@
RM		= @RM@
MV		= @MV@
CP		= @CP@
INSTALL		= @INSTALL@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
datarootdir	= @datarootdir@
bindir		= @bindir@
datadir		= @datadir@
sysconfdir	= @sysconfdir@
libdir		= @libdir@
sbindir		= @sbindir@
localstatedir	= @localstatedir@
DOCDIR		= @DOCDIR@
MODDIR		= @MODDIR@
LOCALEDIR	= @LOCALEDIR@
DATADIR		= @DATADIR@
RUNDIR		= @RUNDIR@
LOGDIR		= @LOGDIR@
SHAREDIR	= @SHAREDIR@
BIN		= atheme-services@EXEEXT@
MKDEP		= @MKDEP@
CFLAGS		= -I. -I../include @CFLAGS@ -DBINDIR=\"$(bindir)\"

VERSION		= @PACKAGE_VERSION@

LIBS		= @LIBS@
LDFLAGS		= @LDFLAGS@ @LTLIBINTL@
RPATH		= @RPATH@
CPPFLAGS	= @CPPFLAGS@
HELP_LINGUAS	= es ru

# Want absolute paths?
SRCDIR		= .
@ABSPATHS@SRCDIR= @SRCDIR@/src

BUILDDIR	= @BUILDDIR@

default: all

BASE_SRCS =				\
	$(SRCDIR)/account.c		\
	$(SRCDIR)/atheme.c		\
	$(SRCDIR)/arc4random.c		\
	$(SRCDIR)/auth.c		\
	$(SRCDIR)/authcookie.c		\
	$(SRCDIR)/balloc.c		\
	$(SRCDIR)/base64.c		\
	$(SRCDIR)/channels.c		\
	$(SRCDIR)/cidr.c		\
	$(SRCDIR)/cmode.c		\
	$(SRCDIR)/commandtree.c		\
	$(SRCDIR)/ctcp-common.c		\
	$(SRCDIR)/conf.c		\
	$(SRCDIR)/confparse.c		\
	$(SRCDIR)/confprocess.c		\
	$(SRCDIR)/connection.c		\
	$(SRCDIR)/crypto.c		\
	$(SRCDIR)/culture.c		\
	$(SRCDIR)/datastream.c		\
	$(SRCDIR)/dlink.c		\
	$(SRCDIR)/event.c		\
	$(SRCDIR)/flags.c		\
	$(SRCDIR)/function.c		\
	$(SRCDIR)/help.c		\
	$(SRCDIR)/hook.c		\
	$(SRCDIR)/linker.c		\
	$(SRCDIR)/logger.c		\
	$(SRCDIR)/match.c		\
	$(SRCDIR)/md5.c			\
	$(SRCDIR)/memory.c		\
	$(SRCDIR)/module.c		\
	$(SRCDIR)/node.c		\
	$(SRCDIR)/object.c		\
	$(SRCDIR)/packet.c		\
	$(SRCDIR)/parse.c		\
	$(SRCDIR)/phandler.c		\
	$(SRCDIR)/pmodule.c		\
	$(SRCDIR)/poll.c		\
	$(SRCDIR)/privs.c		\
	$(SRCDIR)/ptasks.c		\
	$(SRCDIR)/send.c		\
	$(SRCDIR)/servers.c		\
	$(SRCDIR)/services.c		\
	$(SRCDIR)/servtree.c		\
	$(SRCDIR)/signal.c		\
	$(SRCDIR)/string.c		\
	$(SRCDIR)/strshare.c		\
	$(SRCDIR)/svsignore.c		\
	$(SRCDIR)/symbolmatrix.c	\
	$(SRCDIR)/table.c		\
	$(SRCDIR)/template.c		\
	$(SRCDIR)/tokenize.c		\
	$(SRCDIR)/ubase64.c		\
	$(SRCDIR)/users.c		\
	$(SRCDIR)/uid.c			\
	$(SRCDIR)/uplink.c		\
	$(SRCDIR)/xmlrpc.c

SRCS = ${BASE_SRCS} $(SRCDIR)/version.c

OBJS = ${SRCS:.c=.o}

all: atheme-services ../dist/atheme.conf.userserv-example ../dist/atheme.conf.operserv-example

build: all

atheme-services: $(OBJS)
	${CC} ${CFLAGS} ${LDFLAGS} -o $@ ${OBJS} ${LIBS} ${RPATH}
	$(MV) version.c version.c.last

../dist/atheme.conf.userserv-example: ../dist/atheme.conf.example
	(echo '/* atheme.conf.userserv-example, autogenerated from atheme.conf.example */'; \
	sed -e 's@loadmodule "modules/nickserv/identify";@#&@' \
	  -e 's@loadmodule "modules/nickserv/ghost";@#&@' \
	  -e 's@#loadmodule "modules/nickserv/login";@loadmodule "modules/nickserv/login";@' \
	  -e 's/spam;/#spam;/' \
	  -e 's/#no_nick_ownership;/no_nick_ownership;/' \
	  -e 's/nick = "NickServ";/nick = "UserServ";/' \
	  -e 's/user = "NickServ";/user = "UserServ";/' \
	  -e 's/real = "Nickname Services";/real = "User Registration Services";/' ../dist/atheme.conf.example) >../dist/atheme.conf.userserv-example

../dist/atheme.conf.operserv-example: ../dist/atheme.conf.example
	(echo '/* atheme.conf.operserv-example, autogenerated from atheme.conf.example */'; \
	echo '/* This is for an oper services only atheme instance. */'; \
	sed -e '/^\/\* Database backend module/,/^$$/d' \
	  -e '/^\/\* NickServ module/,/^$$/d' \
	  -e '/^\/\* ChanServ module/,/^$$/d' \
	  -e '/modules\/operserv\/akill/d' \
	  -e '/modules\/operserv\/ignore/d' \
	  -e '/modules\/operserv\/soper/d' \
	  -e '/modules\/operserv\/update/d' \
	  -e '/^\/\* MemoServ module/,/^$$/d' \
	  -e '/^\/\* SASL agent module/,/^$$/d' \
	  -e '/^\/\* GameServ module/,/^$$/d' \
	  -e '/modules\/xmlrpc\/account/d' \
	  -e '/modules\/xmlrpc\/channel/d' \
	  -e '/modules\/xmlrpc\/memo/d' \
	  -e 's/name = "services.int"/name = "operserv.int"/' \
	  -e 's/desc = ".*"/desc = "Atheme Operator Services"/' \
	  -e 's/numeric = "00A"/numeric = "00B"/' \
	  -e '/\/\*.*enforce_expire/,/enforce_delay =/d' \
	  -e 's/expire = .*;/expire = 1;/' \
	  -e 's/nick = "OperServ";/nick = "OperServ2";/' \
	  -e 's/nick = "Global";/nick = "Global2";/' \
	  -e 's/spam;/#spam;/' \
	  -e 's/port = 8080/port = 8081/' ../dist/atheme.conf.example) >../dist/atheme.conf.operserv-example

install: build
	$(INSTALL) -m 755 -d $(DESTDIR)$(prefix)
	$(INSTALL) -m 755 -d $(DESTDIR)$(bindir)
	$(INSTALL) -m 755 -d $(DESTDIR)$(sysconfdir)
	$(INSTALL) -m 755 -d $(DESTDIR)$(localstatedir)
	$(INSTALL) -m 755 -d $(DESTDIR)$(DOCDIR)
	$(INSTALL) -m 755 -d $(DESTDIR)$(LOGDIR)
	$(INSTALL) -m 755 -d $(DESTDIR)$(RUNDIR)
	$(INSTALL) -m 755 -d $(DESTDIR)$(DATADIR)
	$(INSTALL) -m 755 -d $(DESTDIR)$(SHAREDIR)/help
	$(INSTALL) -m 755 -c $(BIN) $(DESTDIR)$(bindir)
	$(INSTALL) -m 600 -c ../dist/atheme.conf.example $(DESTDIR)$(sysconfdir)
	$(INSTALL) -m 644 -c ../dist/atheme.motd.example $(DESTDIR)$(sysconfdir)
	[ -r $(DESTDIR)$(sysconfdir)/atheme.motd ] || $(INSTALL) -m 644 -c ../dist/atheme.motd.example $(DESTDIR)$(sysconfdir)/atheme.motd || :
	$(INSTALL) -m 600 -c ../dist/atheme.conf.userserv-example $(DESTDIR)$(sysconfdir)
	$(INSTALL) -m 600 -c ../dist/atheme.conf.operserv-example $(DESTDIR)$(sysconfdir)
	$(INSTALL) -m 644 -c ../dist/atheme.cron.example $(DESTDIR)$(sysconfdir)
	[ -f ${DESTDIR}${bindir}/atheme ] && ${RM} ${DESTDIR}${bindir}/atheme || :
	-${RM} -f $(DESTDIR)${DOCDIR}/HOOKS $(DESTDIR)${DOCDIR}/MODES $(DESTDIR)${DOCDIR}/XMLRPCLIB $(DESTDIR)${DOCDIR}/technical/HOOKS
	(cd ../doc; for i in *; do \
		[ -f $$i ] && $(INSTALL) -m 644 $$i $(DESTDIR)$(DOCDIR); \
		if [ -d $$i ]; then \
			cd $$i; \
			$(INSTALL) -m 755 -d $(DESTDIR)$(DOCDIR)/$$i; \
			for j in *; do \
				[ -f $$j ] && $(INSTALL) -m 644 $$j $(DESTDIR)$(DOCDIR)/$$i; \
			done; \
			cd ..; \
		fi; \
	done; install -m 644 ../NEWS $(DESTDIR)$(DOCDIR)/RELEASE)
	(cd ../help/default; for i in *; do \
		[ -f $$i ] && $(INSTALL) -m 644 $$i $(DESTDIR)$(SHAREDIR)/help; \
		if [ -d $$i ]; then \
			cd $$i; \
			$(INSTALL) -m 755 -d $(DESTDIR)$(SHAREDIR)/help/$$i; \
			for j in *; do \
				[ -f $$j ] && $(INSTALL) -m 644 $$j $(DESTDIR)$(SHAREDIR)/help/$$i; \
			done; \
			cd ..; \
		fi; \
	done)
	-${RM} -f $(DESTDIR)$(SHAREDIR)/help/hostserv/vhostall
	if [ @USE_NLS@ = yes ]; then \
		for lingua in $(HELP_LINGUAS); do \
			$(INSTALL) -m 755 -d $(DESTDIR)$(SHAREDIR)/help/$$lingua; \
			(cd ../help/$$lingua; for i in *; do \
				[ -f $$i ] && $(INSTALL) -m 644 $$i $(DESTDIR)$(SHAREDIR)/help/$$lingua; \
				if [ -d $$i ]; then \
					cd $$i; \
					$(INSTALL) -m 755 -d $(DESTDIR)$(SHAREDIR)/help/$$lingua/$$i; \
					for j in *; do \
						[ -f $$j ] && $(INSTALL) -m 644 $$j $(DESTDIR)$(SHAREDIR)/help/$$lingua/$$i; \
					done; \
					cd ..; \
				fi; \
			done); \
		done; \
	fi

#deinstall:
#	if [ -d ${prefix} ] ; then \
#		$(RM) -rf ${prefix}; \
#	fi

$(SRCDIR)/version.c:
	/bin/sh ./version.sh $(VERSION)

../include/hooktypes.h: $(SRCDIR)/mkhooktypes.sh $(SRCDIR)/hooktypes.in
	PATH=`getconf PATH` sh $(SRCDIR)/mkhooktypes.sh $(SRCDIR)/hooktypes.in >../include/hooktypes.h

.c.o:
	${CC} ${CFLAGS} ${CPPFLAGS} -c $< -o $@

.PHONY: depend clean distclean
# This sed command sucks but I don't know a better way -- jilles
depend:
	${MKDEP} ${PICFLAGS} ${CFLAGS} ${CPPFLAGS} ${BASE_SRCS} | sed -e 's|\([^.]*\.o\):|$(SRCDIR)/\1:|' > .depend

clean:
	${RM} -f *.o *.exe *~ version.c atheme-services.core core atheme-services ../dist/atheme.conf.userserv-example ../include/hooktypes.h

distclean: clean
	${RM} -f Makefile version.c.last .depend

include .depend
