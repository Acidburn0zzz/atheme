# Copyright (c) 2005 Atheme Development Group
# Rights to this code are documented in doc/LICENSE.
#
# This file contains build instructions.
#
# $Id: Makefile.in 4183 2005-12-25 21:01:34Z jilles $
#

CC		= @CC@
RM		= @RM@
MV		= @MV@
CP		= @CP@
INSTALL		= @INSTALL@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
libdir		= @libdir@
MODDIR		= @MODDIR@
BIN		= atheme@EXEEXT@
MKDEP		= @MKDEP@ -DPREFIX=\"@prefix@\" -I../include -I../libatheme @PGINC@ @MYINC@
CFLAGS		= @CFLAGS@ -I../include -I../libatheme @PGINC@ @MYINC@

VERSION		= @PACKAGE_VERSION@

LIBS		= @LIBS@ @PQLIB@ @MYLIB@ -L../libatheme -lorg.atheme.claro.base
LDFLAGS		= @LDFLAGS@
CPPFLAGS	= @CPPFLAGS@

default: all

BASE_SRCS =		\
	atheme.c	\
	authcookie.c	\
	base64.c	\
	cmode.c		\
	commandtree.c	\
	conf.c		\
	confparse.c	\
	crypto.c	\
	dbhandler.c	\
	flags.c		\
	function.c	\
	help.c		\
	match.c		\
	module.c	\
	node.c		\
	packet.c	\
	parse.c		\
	phandler.c	\
	pmodule.c	\
	ptasks.c	\
	services.c	\
	servtree.c	\
	send.c		\
	signal.c	\
	template.c	\
	tokenize.c	\
	ubase64.c	\
	uid.c		\
	uplink.c	\
	xmlrpc.c	\
	version.c

SRCS = ${BASE_SRCS}

OBJS = ${SRCS:.c=.o}

all: atheme

build: all

atheme: $(OBJS)
	${CC} ${CFLAGS} ${LDFLAGS} -o $@ ${OBJS} ${LIBS}
	$(MV) version.c version.c.last

install: build
	$(INSTALL) -m 755 -d $(prefix)
	$(INSTALL) -m 755 -d $(prefix)/bin
	$(INSTALL) -m 755 -d $(prefix)/etc
	$(INSTALL) -m 755 -d $(prefix)/var
	$(INSTALL) -m 755 -c $(BIN) $(prefix)/bin
	$(INSTALL) -m 640 -c ../dist/example.conf $(prefix)/etc
	$(INSTALL) -m 640 -c ../dist/example.userserv.conf $(prefix)/etc
	if [ ! -r $(prefix)/etc/atheme.db ]; then \
		$(INSTALL) -m 640 -c ../dist/atheme.db $(prefix)/etc ; \
	fi
	if [ ! -r $(prefix)/etc/atheme.chk ]; then \
		$(INSTALL) -m 640 -c ../dist/atheme.chk $(prefix)/etc ; \
	fi
	if [ -e $(prefix)/doc ]; then \
		$(RM) -rf $(prefix)/doc ; \
	fi
	if [ -e $(prefix)/help ]; then \
		$(RM) -rf $(prefix)/help ; \
	fi
	$(CP) -R ../doc $(prefix)
	$(CP) -R ../help $(prefix)

	@echo "----------------------------------------------------------------"
	@echo ">>> Remember to cd to ${prefix} and edit your config file.";
	@echo "----------------------------------------------------------------"

#deinstall:
#	if [ -d ${prefix} ] ; then \
#		$(RM) -rf ${prefix}; \
#	fi

version.c:
	/bin/sh ./version.sh $(VERSION)

.c.o:
	${CC} ${CPPFLAGS} ${CFLAGS} -c $< -o $@

.PHONY: depend clean distclean
depend:
	${MKDEP} ${CPPFLAGS} ${BASE_SRCS} > .depend

clean:
	${RM} -f *.o *.exe *~ version.c atheme.core core atheme

distclean: clean
	${RM} -f Makefile version.c.last

include .depend
