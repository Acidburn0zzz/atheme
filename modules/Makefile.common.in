# Copyright (c) 2005 Atheme Development Group.
# Rights to this code are documented in doc/LICENSE.
#
# This file contains common rules.
#
# $Id$
#

default: all

SRCS = ${BASE_SRCS}

OBJS = ${SRCS:.c=.so}

EXTRA_OBJS = ${EXTRA_SRCS:.c=.o}

all: modules

build: all

install: build
	${INSTALL} -d $(DESTDIR)${MODDIR}/modules/$(MODULE)
	${INSTALL} -m 755 *.so $(DESTDIR)${MODDIR}/modules/$(MODULE)

modules: $(EXTRA_OBJS) $(OBJS)

.SUFFIXES: .o .so

.c.o:
	${CC} -c ${PICFLAGS} ${CPPFLAGS} ${CFLAGS} $< -o $@

.c.so:
	${CC} ${PICFLAGS} ${CPPFLAGS} ${CFLAGS} $< -o $@

.PHONY: depend clean distclean

depend: .depend

# This sed command sucks but I don't know a better way -- jilles
.depend:
	${MKDEP} ${PICFLAGS} ${CPPFLAGS} ${CFLAGS} ${SRCS} | sed -e 's|\([^.]*\)\.o:|$(SRCDIR)/\1.so:|' > .depend

clean:
	${RM} -f $(OBJS) $(EXTRA_OBJS)

distclean: clean
	${RM} -f Makefile version.c.last .depend
	
maintainer-clean:
	${RM} -f $(MAINTAINERCLEANFILES)

include .depend
